{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "CalculationLogs",
  "description": "Firestore schema for audit trail of all calculation requests and responses (HIPAA compliance)",
  "type": "object",
  "required": ["request", "response", "timestamp", "aiUsed", "cacheHit"],
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique calculation ID (auto-generated by Firestore)"
    },
    "userId": {
      "type": "string",
      "description": "Optional user ID (if authenticated)",
      "examples": ["user_abc123"]
    },
    "request": {
      "type": "object",
      "required": ["drug", "sig", "daysSupply"],
      "properties": {
        "drug": {
          "type": "object",
          "properties": {
            "name": {
              "type": "string",
              "description": "Drug name (if provided)",
              "examples": ["Lisinopril"]
            },
            "rxcui": {
              "type": "string",
              "description": "RxCUI (if provided)",
              "examples": ["314076"]
            }
          }
        },
        "sig": {
          "type": "object",
          "required": ["dose", "frequency", "unit"],
          "properties": {
            "dose": {
              "type": "number",
              "description": "Dose per administration",
              "examples": [1, 2, 0.5]
            },
            "frequency": {
              "type": "number",
              "description": "Frequency per day",
              "examples": [1, 2, 3]
            },
            "unit": {
              "type": "string",
              "description": "Dosage unit",
              "examples": ["tablet", "capsule", "ml"]
            }
          }
        },
        "daysSupply": {
          "type": "number",
          "description": "Days' supply",
          "examples": [30, 90]
        }
      }
    },
    "response": {
      "type": "object",
      "required": ["success", "executionTime"],
      "properties": {
        "success": {
          "type": "boolean",
          "description": "Whether the calculation succeeded"
        },
        "totalQuantity": {
          "type": "number",
          "description": "Total quantity calculated (if successful)"
        },
        "recommendedPackages": {
          "type": "number",
          "description": "Number of recommended packages (if successful)"
        },
        "executionTime": {
          "type": "number",
          "description": "Execution time in milliseconds"
        },
        "errorCode": {
          "type": "string",
          "description": "Error code (if failed)",
          "examples": ["DRUG_NOT_FOUND", "VALIDATION_ERROR"]
        }
      }
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "When this calculation was performed (ISO 8601 timestamp)"
    },
    "aiUsed": {
      "type": "boolean",
      "description": "Whether AI enhancement was used (OpenAI)"
    },
    "cacheHit": {
      "type": "boolean",
      "description": "Whether cache was hit for drug normalization or NDC lookup"
    },
    "ipAddress": {
      "type": "string",
      "description": "Client IP address (for security/audit)",
      "examples": ["192.168.1.1"]
    }
  },
  "indexes": [
    {
      "fields": [
        { "fieldPath": "userId", "order": "ASCENDING" },
        { "fieldPath": "timestamp", "order": "DESCENDING" }
      ],
      "description": "Index for querying user's calculation history"
    },
    {
      "fields": [
        { "fieldPath": "timestamp", "order": "DESCENDING" }
      ],
      "description": "Index for querying recent calculations"
    },
    {
      "fields": [
        { "fieldPath": "cacheHit", "order": "ASCENDING" },
        { "fieldPath": "timestamp", "order": "DESCENDING" }
      ],
      "description": "Index for cache performance analytics"
    },
    {
      "fields": [
        { "fieldPath": "aiUsed", "order": "ASCENDING" },
        { "fieldPath": "timestamp", "order": "DESCENDING" }
      ],
      "description": "Index for AI usage analytics"
    }
  ],
  "notes": {
    "retention": "7 years (HIPAA requirement)",
    "writeOnce": "Documents should be write-once (tamper-proof)",
    "security": "Firestore security rules must restrict access to authenticated users or Cloud Functions only",
    "phi": "No PHI (Protected Health Information) should be stored in logs",
    "redaction": "All drug names and user inputs are already redacted in the calculation flow"
  }
}

